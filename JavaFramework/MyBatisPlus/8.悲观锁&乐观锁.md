##  é”

- åœºæ™¯ï¼š

  ä¸€ä»¶å•†å“æˆæœ¬80ï¼Œå”®ä»·100ï¼›è€æ¿é€šçŸ¥å°æå°†å”®ä»·å¢åŠ 50ï¼Œæ­¤æ—¶å°æè€½æäº†ä¸€å°æ—¶ï¼Œåˆšå¥½ä¸€å°æ—¶åè€æ¿è®©å°ç‹å°†å”®ä»·é™30ï¼ˆä»¥ä¸ºå°ææ—©å·²ä¿®æ”¹å”®ä»·ä¸º150ï¼‰

  æ­¤æ—¶å°ç‹å°æåŒæ—¶æ“ä½œåå°ï¼Œå°æå–å‡ºåŸå”®ä»·100+50=150ï¼Œå°ç‹å–å‡ºåŸå”®ä»·100-30=70ï¼›è‹¥æ²¡æœ‰é”ï¼Œåˆ™å°ç‹çš„æ“ä½œä¼šè¦†ç›–å°æçš„æ“ä½œ

  

- æ‚²è§‚é”ï¼šå°ææ“ä½œæ—¶ä¸Šé”ï¼Œå½“æ“ä½œå®Œæˆé‡Šæ”¾ï¼›å°ç‹å†è·å¾—é”ï¼Œæ­¤æ—¶å°±æ˜¯150-30=120

- ä¹è§‚é”ï¼ˆè¡¨ä¸­è®¾ç½®versionå®ç°ï¼‰ï¼šå°ç‹ä¿å­˜ä»·æ ¼å‰ï¼Œæ£€æŸ¥ä»·æ ¼æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼›è‹¥æ”¹è¿‡åˆ™å–å‡ºä¿®æ”¹åçš„å€¼å†è¿›è¡Œæ“ä½œ

  å®ç°æµç¨‹

  1. å–å‡ºè®°å½•æ—¶ï¼Œè·å–å½“å‰versionï¼š`select id,name,price,version from goods where id=1`

  2. æ›´æ–°æ—¶ï¼Œversion+1ï¼Œè‹¥whereåˆ¤æ–­versionä¸å–å‡ºæ—¶ä¸ä¸€è‡´åˆ™æ›´æ–°å¤±è´¥

     `update goods set price=price+50 version=version+1 where id=1 and version=1`



####  MybatisPluså®ç°ä¹è§‚é”

æ·»åŠ ä¹è§‚é”æ’ä»¶ï¼ˆMyBatisPlueConfigï¼‰ï¼š

```java
interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
```

åœ¨å®ä½“ç±»çš„versionå±æ€§åŠ ä¸Š`@Version`æ³¨è§£ğŸ“Œ

```java
@Data
public class Goods {
     private Long id;
     private String name;
     private BigDecimal price;
     @Version
     private Integer version;
}
```

æµ‹è¯•ï¼š

```java
public void  testPriceUpdate(){
        //æ¨¡æ‹Ÿä¿®æ”¹å†²çª
//        å°ææŸ¥è¯¢å•†å“ä»·æ ¼
        Goods goodLi = goodsMapper.selectById(11);
        BigDecimal priceL=goodLi.getPrice();
        System.out.println(priceL);

//        å°ç‹æŸ¥è¯¢å•†å“
        Goods goodsWang = goodsMapper.selectById(11);
        BigDecimal priceW=goodsWang.getPrice();
        System.out.println(priceW);

//        å°æä¿®æ”¹ä»·æ ¼
        goodLi.setPrice(new BigDecimal(50).add( priceL));
        goodsMapper.updateById(goodLi);
//        å°ç‹ä¿®æ”¹ä»·æ ¼
        goodsWang.setPrice(priceW.subtract(new BigDecimal(30)));
        int i = goodsMapper.updateById(goodsWang);
        //åˆ¤æ–­å°ç‹æ“ä½œæ˜¯å¦ç”Ÿæ•ˆ
        if(i==0){
            //é‡æ–°è·å–å•†å“ä¿¡æ¯è¿›è¡Œä¿®æ”¹
            Goods goodsNew = goodsMapper.selectById(11);
            goodsNew.setPrice(goodsNew.getPrice().subtract(new BigDecimal(30)));
            goodsMapper.updateById(goodsNew);

        }
        Goods goodsBoss = goodsMapper.selectById(11);
        System.out.println(goodsBoss);
    }
```

