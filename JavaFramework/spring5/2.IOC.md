##  IOCå®¹å™¨



###  IOCåº•å±‚åŸç†

> xmlè§£æï¼Œå·¥å‚æ¨¡å¼ï¼Œåå°„

![image-20230716093619647](./Typora_img/2.IOC.assets/image-20230716093619647.png)

----

###  IOCæ¥å£ï¼ˆBeanFactoryï¼‰

> åŸºäºIOCå®¹å™¨å®Œæˆï¼Œå®¹å™¨åº•å±‚å°±æ˜¯å¯¹è±¡å·¥å‚

**springæä¾›å®ç°IOCå®¹å™¨çš„ä¸¤ç§æ–¹å¼ï¼ˆä¸¤ä¸ªæ¥å£ï¼‰ï¼š**

- BeanFactoryï¼ˆå¼€å‘ä¸­ä¸å¸¸ç”¨ï¼Œæ˜¯springå†…éƒ¨ä½¿ç”¨ï¼‰

  *åŠ è½½é…ç½®æ–‡ä»¶ä¸ä¼šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨è·å–æ—¶åˆ›å»º

- `ApplicationContext`ï¼ˆBeanFactoryçš„å­æ¥å£ï¼Œæä¾›ç»™å¼€å‘è€…ä½¿ç”¨ï¼‰

  *åŠ è½½é…ç½®æ–‡ä»¶å³åˆ›å»ºå¯¹è±¡

  *è¯¥æ¥å£çš„å®ç°ç±»ï¼š

  ![image-20230716100540399](./Typora_img/2.IOC.assets/image-20230716100540399.png)



###  IOCä¸­çš„Beanç®¡ç†

> æŒ‡çš„æ˜¯ï¼šç”±springåˆ›å»ºå¯¹è±¡ï¼Œæ³¨å…¥å±æ€§ï¼›ï¼ˆåˆ›å»ºå¯¹è±¡æ—¶è°ƒç”¨é»˜è®¤çš„æ— å‚æ„é€ ï¼‰

####  Beanä¸¤ç§ç±»å‹

- æ™®é€šbean

  åœ¨xmlé…ç½®ä¸­å®šä¹‰beanç±»å‹å’Œè¿”å›ç±»å‹ä¸€è‡´

- å·¥å‚beanï¼ˆFactoryBeanï¼‰

  åœ¨xmlé…ç½®ä¸­å®šä¹‰beanç±»å‹å’Œè¿”å›ç±»å‹ä¸ä¸€è‡´

  ```java
  public class MyBean implements FactoryBean<Student> {
      @Override
      public Student getObject() throws Exception {
          Student student = new Student();
          student.setCourse(new String[]{"list"});
          return student;//è¿”å›ç±»å‹ä¸ºstudentï¼Œå®šä¹‰beanç±»å‹ä¸ºMyBean
      }
  
      @Override
      public Class<?> getObjectType() {
          return null;
      }
  
      @Override
      public boolean isSingleton() {
          return FactoryBean.super.isSingleton();
      }
  }
  ```

---

#### Beanä½œç”¨åŸŸ

springå¯ä»¥è®¾ç½®beanæ˜¯å•å®ä¾‹è¿˜æ˜¯å¤šå®ä¾‹å¯¹è±¡ï¼ˆğŸ“Œ`é»˜è®¤ä¸ºå•å®ä¾‹`ï¼‰

ğŸ“Œè®¾ç½®xmlé…ç½®æ–‡ä»¶beanæ ‡ç­¾çš„scopeå±æ€§å€¼ï¼š

1. singletonï¼ˆé»˜è®¤å€¼ï¼‰ï¼šåŠ è½½é…ç½®æ–‡ä»¶æ—¶åˆ›å»ºå¯¹è±¡
2. prototypeï¼šåœ¨è°ƒç”¨getBean()æ—¶åˆ›å»ºå¯¹è±¡ï¼Œæ¯æ¬¡è°ƒç”¨è¿”å›ä¸åŒçš„å¯¹è±¡å®ä¾‹

```xml
    <bean id="mybean" class="com.loy.spring.factorybean.MyBean" scope="prototype"></bean>
```

---

####  Beanç”Ÿå‘½å‘¨æœŸï¼ˆå®Œæ•´ä¸ƒä¸ªæ­¥éª¤ï¼‰

1. æ„é€ å™¨åˆ›å»ºbeanå®ä¾‹
2. ä¸ºbeanè®¾ç½®å±æ€§å€¼å’Œå¼•ç”¨å…¶ä»–beanï¼›2.1å°†beanå®ä¾‹ä¼ é€’ç»™å‰ç½®å¤„ç†å™¨
3. è°ƒç”¨beançš„åˆå§‹åŒ–æ–¹æ³•ï¼›3.1å°†beanå®ä¾‹ä¼ é€’ç»™åç½®å¤„ç†å™¨
4. ä½¿ç”¨bean
5. å…³é—­å®¹å™¨åï¼Œé”€æ¯bean 

BeanLifeCycle.java

```java
package com.loy.spring.bean;
public class BeanLifeCycle {
    //æ¼”ç¤ºbeanç”Ÿå‘½å‘¨æœŸ
    private String beanName;

    public BeanLifeCycle() {
        System.out.println("ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨æ— å‚æ„é€ ");
    }

    public void setBeanName(String beanName) {
        this.beanName = beanName;
        System.out.println("ç¬¬äºŒæ­¥ï¼šè°ƒç”¨setæ–¹æ³•è®¾ç½®å±æ€§å€¼");
    }
    public void init(){
        System.out.println("ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨initåˆå§‹åŒ–æ–¹æ³•");//éœ€è¦åœ¨xmlæ–‡ä»¶beanæ ‡ç­¾è®¾ç½®init-methodå±æ€§ï¼Œå€¼ä¸ºè¯¥æ–¹æ³•åï¼ˆinitï¼‰
    }
    public void destroy(){
        System.out.println("ç¬¬äº”æ­¥ï¼šé”€æ¯bean");
    }
}

```

BeanPostLift.jva

```java
public class BeanPostLift implements BeanPostProcessor {
//    é…ç½®å‰åç½®å¤„ç†å™¨
@Override
public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
    System.out.println("å‰ç½®æ–¹æ³•è¢«è°ƒç”¨");
    return bean;
}

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        System.out.println("åç½®å¤„ç†å™¨è¢«è°ƒç”¨");
        return bean;
    }
}
```

TestBeanLife.java

```java
public class TestBeanLife {
    public static void main(String[] args) {
        ClassPathXmlApplicationContext cla = new ClassPathXmlApplicationContext("beanLife.xml");
        BeanLifeCycle beanLife = cla.getBean("beanLife", BeanLifeCycle.class);
        System.out.println("ç¬¬å››æ­¥ï¼šä½¿ç”¨beanï¼›"+beanLife);
        cla.close();
    }
}
```

beanLife.xml

```xml
<bean id="beanLife" class="com.loy.spring.bean.BeanLifeCycle" init-method="init" p:beanName="mybean" destroy-method="destroy"></bean>
<!--    é…ç½®å‰åç½®å¤„ç†å™¨ï¼Œåœ¨æœ¬é…ç½®æ–‡ä»¶çš„beanéƒ½ä¼šè¢«åˆ›å»ºå¤„ç†å™¨-->
    <bean id="beanpost" class="com.loy.spring.bean.BeanPostLift"></bean>
```

![image-20230717100540511](./Typora_img/2.IOC.assets/image-20230717100540511.png)

---

####  å¤–éƒ¨å±æ€§æ–‡ä»¶

ä½¿ç”¨xmlé…ç½®è¿æ¥æ± ï¼ˆè®¾ç½®åç§°ç©ºé—´contextï¼‰

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans 				                  http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
"> 
<!--    å¼•å…¥å¤–éƒ¨å±æ€§æ–‡ä»¶-->
    <context:property-placeholder location="classpath:jdbcdruid.properties"></context:property-placeholder>
<!--    é…ç½®è¿æ¥æ± -->
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
        <property name="driverClassName" value="${driverClassName}"></property>
        <property name="url" value="${url}"></property>
        <property name="username" value="${username}"></property>
        <property name="password" value="${password}"></property>
    </bean>    
</beans>
```



####  å®ç°ç®¡ç†çš„ä¸¤ç§ä¸»è¦æ–¹å¼

1. ####  åŸºäºxml

   â‘ åˆ›å»ºxmlé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå¯¹è±¡

   ```xml
   <bean id="user" class="com.loy.spring.User"></bean>
   <!--
   beanæ ‡ç­¾å¸¸ç”¨å±æ€§ï¼š
   - idï¼šå”¯ä¸€æ ‡è¯†
   - classï¼šå¯¹åº”ç±»çš„å…¨ç±»å
   -->
   ```

   â‘¡ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ï¼šä¹Ÿç§°å±æ€§æ³¨å…¥

   **éœ€è¦è¯¥å±æ€§çš„setæ–¹æ³•**

   1. å±æ€§ä¸º*åŸºæœ¬æ•°æ®ç±»å‹*

      - æ–¹å¼ä¸€ï¼šé€šè¿‡propertyæ ‡ç­¾è®¾ç½®

        ```xml
            <bean id="user" class="com.loy.spring.User">
                <!--æ–¹å¼ä¸€ï¼š-->
        <!--    ä½¿ç”¨propertyå®Œæˆå±æ€§æ³¨å…¥ï¼ˆç±»ä¼¼setæ–¹æ³•ï¼‰
                nameï¼šç±»é‡Œçš„å±æ€§å
                valueï¼šå±æ€§åçš„å€¼
        -->
                <property name="userId" value="1011"></property> 
            </bean>
        
            <!--     æ–¹å¼äºŒï¼š
                    ğŸ¯é€šè¿‡ p:å±æ€§å="å€¼"ï¼Œç®€åŒ–propertyæ ‡ç­¾
            -->
            <bean id="user" class="com.loy.spring.User" p:userId="10021"></bean>
        
        <!--å±æ€§å€¼æœ‰ç‰¹æ®Šç¬¦å·æ—¶ï¼š-->
        <!--        1.nullå€¼è®¾ç½®
                    <property name="userId"><null/></property>
        
                    2.ç‰¹æ®Šå­—ç¬¦è®¾ç½®
                    <property name="address">
                        <value><![CDATA[<<ä¸Šæµ·>>]]></value>
                    </property>
        -->
        ```

      - æ–¹å¼äºŒï¼šé€šè¿‡constructor-argæ ‡ç­¾æœ‰å‚æ„é€ 

        ```xml
         <!--    åˆ›å»ºå¯¹è±¡-->
            <bean id="user1" class="com.loy.spring.User">
                <!--    ä½¿ç”¨constructor-argå®Œæˆå±æ€§æ³¨å…¥ï¼ˆç±»ä¼¼æœ‰å‚æ„é€ æ–¹æ³•ï¼‰
                        å¤šä¸ªå‚æ•°ä½¿ç”¨å¤šä¸ªæ ‡ç­¾è¿›è¡Œæ³¨å…¥
                        <constructor-arg name="userId" value="1002"></constructor-arg>
                        <constructor-arg name="userName" value="å¼ ä¸‰"></constructor-arg>
                -->
               <constructor-arg name="userId" value="1002"></constructor-arg>
            </bean>
        ```

   2. å±æ€§ä¸º*å¯¹è±¡ç±»å‹*

      - æ–¹å¼ä¸€ï¼šæ³¨å…¥å¤–éƒ¨bean

        ï¼ˆåœºæ™¯ï¼šä¸€ä¸ªå¯¹è±¡å†…éœ€è¦åˆ›å»ºå¦å¤–ä¸€ä¸ªç±»è°ƒç”¨å…¶æ–¹æ³•æ—¶ï¼‰

        ```xml
        <!--åˆ›å»ºbookDaoImplå¯¹è±¡-->	
        <bean id="bookDao" class="com.loy.spring.dao.impl.BookDaoImpl"></bean>
        <!--åˆ›å»ºbookServiceå¯¹è±¡-->
        <bean id="bookService" class="com.loy.spring.service.BookService">
                <!--
                å¤–éƒ¨beanæ³¨å…¥ï¼š
                 -   æ³¨å…¥BookDaoImplå¯¹è±¡
                 -   refï¼šä¸Šè¿°idä¸º bookDao
                -->
                <property name="bookDaoImpl" ref="bookDao"></property>
        </bean>
        ```

      - æ–¹å¼äºŒï¼šæ³¨å…¥å†…éƒ¨bean

        ï¼ˆåœºæ™¯ï¼šä¸€ä¸ªbeanä¸­æ¶‰åŠå…¶ä»–beanå±æ€§æ—¶ï¼Œä¾‹å¦‚å‘˜å·¥ä¸éƒ¨é—¨ä¸­ï¼Œå‘˜å·¥beanæœ‰éƒ¨é—¨å¯¹è±¡å±æ€§ï¼‰

        ```xml
        <!--    æ³¨å…¥å†…éƒ¨bean-->
            <bean class="com.loy.spring.bean.Emp" id="emp">
                <property name="eName" value="å¼ ä¸‰"></property>
                <property name="eGender" value="ç”·"></property>
                
        <!--        è®¾ç½®éƒ¨é—¨å±æ€§-->
                <property name="dept">
                    <bean id="dept" class="com.loy.spring.bean.Dept">
                        <property name="dName" value="æŠ€æœ¯éƒ¨"></property>
                    </bean>
                </property>
            </bean>
        
        
        <!--    æ–¹å¼2ï¼šç±»ä¼¼å¤–éƒ¨æ³¨å…¥-->
            <bean class="com.loy.spring.bean.Emp" id="emp1">
                <property name="eName" value="æå››"></property>
                <property name="eGender" value="ç”·"></property>
                <!--        è®¾ç½®éƒ¨é—¨å±æ€§-->
        <!--        å†™æ³•1ï¼š-->
                <property name="dept" ref="dept1"></property>
        <!--        å†™æ³•2ï¼šï¼ˆæ­¤æ–¹å¼è¦æ±‚Empç±»éœ€è¦æœ‰getDeptæ–¹æ³•ï¼‰
                      <property name="dept.dName" value="ç ”å‘éƒ¨"></property>
        -->
              
            </bean>
            <bean id="dept1" class="com.loy.spring.bean.Dept">
            <property name="dName" value="æŠ€æœ¯éƒ¨"></property>
            </bean>
        ```

   3. å±æ€§ä¸º*é›†åˆç±»å‹*

      ```xml
      <?xml version="1.0" encoding="UTF-8"?>
      <beans xmlns="http://www.springframework.org/schema/beans"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:p="http://www.springframework.org/schema/p"
             <!--ğŸ“Œå®šä¹‰utilç©ºé—´ -->
             xmlns:util="http://www.springframework.org/schema/util"
             xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
              <!--ğŸ“Œå®šä¹‰utilç©ºé—´ -->
             http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
      >
      
      <!--    ç”¨äºæå–é›†åˆæ³¨å…¥çš„æ“ä½œ-->
        <util:list id="courseList">
            <value>å¼ ä¸‰</value>
        </util:list>
        <util:map id="map">
             <entry key="java" value="java"></entry>
        </util:map>
          <bean id="Stu" class="com.loy.spring.bean.Student" p:list-ref="courseList" p:map-ref="map"></bean>
      </beans>
      ```

2. ####  ğŸ“Œ**åŸºäºæ³¨è§£**

   > æ³¨è§£ï¼šæ˜¯ä¸€ç§ä»£ç ç‰¹æ®Šæ ‡è®°ï¼›æ ¼å¼ï¼š@æ³¨è§£å(å±æ€§å=å€¼ï¼Œå±æ€§å=å€¼...)
   >
   > Springé’ˆå¯¹beanç®¡ç†æä¾›çš„æ³¨è§£ï¼š
   >
   > 1. @Component
   > 2. @Serviceï¼ˆæ¨èserviceå±‚ä½¿ç”¨ï¼‰
   > 3. @Controllerï¼ˆæ¨èwebå±‚ä½¿ç”¨ï¼‰
   > 4. @Repositoryï¼ˆæ¨èdaoå±‚ä½¿ç”¨ï¼‰

   â€‹    å‡†å¤‡ï¼šå¼•å…¥aopåŒ…

   å¼€å¯ç»„ä»¶æ‰«æ

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:context="http://www.springframework.org/schema/context"
          xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
   http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
   ">
   
       <!--    å¼€å¯ç»„ä»¶æ‰«æ:
       å¤šä¸ªåŒ…ç”¨é€—å·éš”å¼€ï¼Œæˆ–è€…ç›´æ¥å†™åˆ°è¯¥åŒ…ä¸Šå±‚ç›®å½•
       ğŸ“Œä¸€èˆ¬ä¸å»ºè®®æ‰«æå…¨éƒ¨ç±»ï¼Œä½¿ç”¨ä¸‹è¿°è‡ªå®šä¹‰æ‰«æ
       -->
       <context:component-scan base-package="com.loy.spring" ></context:component-scan>
       
       <!--è‡ªå®šä¹‰æ‰«æï¼š-->
       <context:component-scan base-package="com.loy.spring" use-default-filters="false" >
   <!--        è¡¨ç¤ºæ‰«ææ³¨è§£ç±»å‹ä¸ºControllerçš„ç±»ä¼šè¢«æ‰«æ-->
           <context:include-filter type="annotation" expression="org.springframework.stereotype.Controller"></context:include-filter>
   <!--        è¡¨ç¤ºä¸æ‰«æRepositoryç±»å‹çš„æ³¨è§£-->
           <context:exclude-filter type="annotation" expression="org.springframework.stereotype.Repository"></context:exclude-filter>
       </context:component-scan>
   </beans>
   ```

   â‘ ä½¿ç”¨æ³¨è§£åˆ›å»ºå¯¹è±¡

   ```java
   package com.loy.spring.service;
   import org.springframework.stereotype.Component;
   import org.springframework.stereotype.Service;
   /* æ³¨è§£æ–¹å¼åˆ›å»ºå¯¹è±¡
   *  @Service(value="anttService") é»˜è®¤ä¸ºå°å†™ç±»åï¼Œå¯çœç•¥ä¸å†™
   *  ç­‰åŒxmlæ–¹å¼é…ç½®çš„<bean id="anttService" class=..../>
   * */
   @Service
   public class AnttService {
       public void add(){
           System.out.println("this is add method");
       }
   }
   
   ```

   â‘¡æ³¨è§£æ–¹å¼å®ç°å±æ€§æ³¨å…¥

   **ä¸éœ€è¦å±æ€§çš„setæ–¹æ³•å³å¯è¿›è¡Œå±æ€§æ³¨å…¥**

   DaoImpl.java

   ```java
   @Repository(value = "antDaoImpl1")//valueç”¨äºé…åˆ@Qualifierä½¿ç”¨
   public class AntDaoImpl implements AntDao {
       @Override
       public void add(){
           System.out.println("this is AntDao add method");
       }
   }
   ```

   AntService.java

   ```java
   /* æ³¨è§£æ–¹å¼åˆ›å»ºå¯¹è±¡
   *  @Service(value="anttService") é»˜è®¤ä¸ºå°å†™ç±»åï¼Œå¯çœç•¥ä¸å†™
   *  ç­‰åŒxmlæ–¹å¼é…ç½®çš„<bean id="anttService" class=..../>
   * */
   @Service
   public class AnttService {
       private AntDao antDao;//ä¸ä½¿ç”¨æ³¨è§£
       public void add(){
           antDao.add();
           System.out.println("this is add method;è°ƒç”¨äº†AntDaoç±»ä¸­çš„addæ–¹æ³• ");
       }
   }
   ```

   

   1. @AutoWiredï¼šæ ¹æ®å±æ€§ç±»å‹è‡ªåŠ¨è£…é…

      ```java
      @Autowired
      private AntDaoImpl antDaoImpl;//å½“daoæ¥å£æœ‰å¤šä¸ªå®ç°ç±»ï¼Œæ­¤æ–¹æ³•ä¸å¯ç”¨;
      ```

   2. @Qualifierï¼šæ ¹æ®å±æ€§åæ³¨å…¥ï¼ˆä¸@Autowiredä¸€èµ·ä½¿ç”¨ï¼‰

      ```java
      @Autowired
      @Qualifier(value = "antDaoImpl1")
      private AntDao antDao;//æ­¤æ—¶å°†ä¼šæ³¨å…¥åˆ°å…·ä½“å®ç°ç±»
      ```

   3. @Resourceï¼šå¯ä»¥æ ¹æ®å±æ€§ç±»å‹/å±æ€§åæ³¨å…¥ï¼ˆjavaxå†…ç½®ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼‰

      æ ¹æ®åç§°æ³¨å…¥æ ¼å¼ï¼š@Resource(name="value")

   4. @Valueï¼šæ³¨å…¥æ™®é€šç±»å‹å±æ€§

      ```java
      @Value(value = "loy")
      private String name;
      ```

      



