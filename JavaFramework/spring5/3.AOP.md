##  AOP

> åœ¨ä¸ä¿®æ”¹å·²æœ‰æºä»£ç çš„æƒ…å†µä¸‹ï¼Œå¢åŠ æ–°åŠŸèƒ½

###  AOPæœ¯è¯­

- è¿æ¥ç‚¹

  **å¯ä»¥**è¢«å¢å¼ºçš„æ–¹æ³•ï¼Œç§°ä¸ºè¿æ¥ç‚¹

- åˆ‡å…¥ç‚¹

  **å®é™…**è¢«å¢å¼ºçš„æ–¹æ³•ï¼Œç§°ä¸ºè¿æ¥ç‚¹

- é€šçŸ¥ï¼ˆå¢å¼ºï¼‰

  åœ¨å®é™…è¢«å¢å¼ºæ–¹æ³•é‡Œï¼Œæ–°æ·»åŠ çš„ä»£ç é€»è¾‘ç§°ä¸ºé€šçŸ¥

  1. å‰ç½®é€šçŸ¥ï¼ˆåˆ‡å…¥ç‚¹å‰æ‰§è¡Œï¼‰
  2. åç½®é€šçŸ¥ï¼ˆåˆ‡å…¥ç‚¹åæ‰§è¡Œï¼‰
  3. ç¯ç»•é€šçŸ¥ï¼ˆåˆ‡å…¥ç‚¹å‰åéƒ½æ‰§è¡Œï¼‰
  4. å¼‚å¸¸é€šçŸ¥ï¼ˆå¢åŠ çš„ä»£ç é€»è¾‘å‡ºç°å¼‚å¸¸æ‰§è¡Œï¼‰
  5. æœ€ç»ˆé€šçŸ¥ï¼ˆç±»ä¼¼try/catchä¸­çš„finallyï¼‰

- åˆ‡é¢

  æŠŠé€šçŸ¥åº”ç”¨åˆ°åˆ‡å…¥ç‚¹çš„è¿‡ç¨‹

---

###  AOPåº•å±‚åŸç†

ä¸¤ç§åŠ¨æ€ä»£ç†æƒ…å†µï¼š

1. æœ‰æ¥å£æƒ…å†µï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†

   ![1](./Typora_img/3.AOP.assets/image-20230718081810310.png)

   ```java
   public class JdkProxy {//    jdkåŠ¨æ€ä»£ç†åº•å±‚åŸç†
   
       //    åˆ›å»ºæ¥å£å®ç°ç±»ä»£ç†å¯¹è±¡
       public static void main(String[] args) {
           Class[] interfaces = {UserDao.class};
       /*æ–¹å¼ä¸€ï¼šä½¿ç”¨åŒ¿åå†…éƒ¨ç±»å®ç°
       Proxy.newProxyInstance(JdkProxy.class.getClassLoader(), interfaces, new InvocationHandler() {
           @Override
           public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
               return null;
           }
       });
       */
   
   //    æ–¹å¼äºŒï¼šä½¿ç”¨å¯¹è±¡å®ç°InvocationHandleræ¥å£
           UserDao userDao = (UserDao) Proxy.newProxyInstance(JdkProxy.class.getClassLoader(), interfaces, new UserDaoProxy(new UserDaoImpl()));
           System.out.println(userDao.add(1, 2));
       }
       
   static class UserDaoProxy implements InvocationHandler {
           //    ä»£ç†å¯¹è±¡
           private Object object;
           //å°†ä»£ç†å¯¹è±¡ä¼ å…¥
           public UserDaoProxy(Object object) {
               this.object = object;
           }
   
           @Override
           public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
               //        éœ€è¦å¢å¼ºçš„æ–¹æ³•ä¹‹å‰æ‰§è¡Œçš„ä»£ç 
               System.out.println(method.getName() + "æ‰§è¡Œå‰è¾“å‡ºï¼›ä¼ é€’çš„å‚æ•°ï¼š" + Arrays.toString(args));
   //            è¢«å¢å¼ºçš„æ–¹æ³•æ‰§è¡Œ
               Object invoke = method.invoke(object, args);
   
               //        éœ€è¦å¢å¼ºçš„æ–¹æ³•ä¹‹å‰æ‰§è¡Œçš„ä»£ç 
               System.out.println("æ–¹æ³•æ‰§è¡Œä¹‹å" + object);
               return invoke;
           }
       }
   }
   ```

   

2. æ²¡æœ‰æ¥å£æƒ…å†µï¼Œä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†

   ![image-20230718081920148](./Typora_img/3.AOP.assets/image-20230718081920148.png)

---

###  AOPæ“ä½œ

> springæ¡†æ¶ä¸€èˆ¬åŸºäºAspectJå®ç°AOPæ“ä½œï¼›
>
> AspectJï¼šæ˜¯ç‹¬ç«‹çš„æ¡†æ¶ï¼Œä¸æ˜¯Springç»„æˆéƒ¨åˆ†ï¼Œç»å¸¸å°†ä¸¤è€…ç»“åˆå®ç°AOPæ“ä½œ

####  åŸºäºAspectJå®ç°AOPæ“ä½œ

å¼•å…¥ä¾èµ–ï¼š

![image-20230718092645599](./Typora_img/3.AOP.assets/image-20230718092645599.png)

é¢„å¤‡çŸ¥è¯†ï¼š

åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š`execution([æƒé™ä¿®é¥°ç¬¦] [è¿”å›ç±»å‹] [å…¨ç±»å] [æ–¹æ³•å]( [å‚æ•°åˆ—è¡¨] ) )`

ç¤ºä¾‹ï¼š(è¯­æ³•è§„åˆ™ï¼Œå‚æ•°åˆ—è¡¨ä½¿ç”¨ .. å ä½ï¼Œä¸éœ€è¦å†™å®é™…å‚æ•°)

- å¯¹æŒ‡å®šæ–¹æ³•å¢å¼ºï¼š`execution(* com.loy.dao.UserDao.add(..))`
- å¯¹æŒ‡å®šç±»æ‰€æœ‰æ–¹æ³•å¢å¼ºï¼š`execution(* com.loy.UserDao.*(..))`
- å¯¹æ‰€æœ‰ç±»ä¸­æ‰€æœ‰æ–¹æ³•å¢å¼ºï¼š`execution(* com.loy.*.*(..))`

1. #### xmlæ–¹å¼ï¼ˆäº†è§£ï¼‰

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:aop="http://www.springframework.org/schema/aop"
          xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
   ">
   
       <bean id="book" class="com.loy.aop.xml.Book"></bean>
       <bean id="bookProxy" class="com.loy.aop.xml.BookProxy"></bean>
   <!--    é…ç½®aopå¢å¼º-->
       <aop:config>
   <!--        åˆ‡å…¥ç‚¹-->
           <aop:pointcut id="add" expression="execution(* com.loy.aop.xml.Book.getId(..))"></aop:pointcut>
   <!--        é…ç½®åˆ‡é¢-->
           <aop:aspect ref="bookProxy">
   <!--            å¢å¼ºåœ¨åˆ‡å…¥ç‚¹ä¸Š-->
               <aop:before method="before" pointcut-ref="add"></aop:before>
           </aop:aspect>
       </aop:config>
   </beans>
   ```

   

2. #### æ³¨è§£æ–¹å¼ï¼ˆğŸ“Œæ¨èå¼€å‘ä¸­ä½¿ç”¨ï¼‰

   é…ç½®ç±»

   ```java
   @Configuration
   @ComponentScan(basePackages = "com.loy.aop")
   @EnableAspectJAutoProxy(proxyTargetClass = true)//å¼€å¯ç”Ÿæˆä»£ç†å¯¹è±¡
   public class SpringConfig {
   }
   ```

   å¢å¼ºç±»

   ```java
   @Service
   @Aspect//ç”Ÿæˆä»£ç†å¯¹è±¡
   @Order(1)//è®¾ç½®ä¼˜å…ˆçº§
   public class UserProxy {//å¢å¼ºç±»
   //   ğŸ“Œ æŠ½å–ç›¸åŒåˆ‡å…¥ç‚¹
     /*  @Pointcut(value = "execution(* com.loy.aop.ant.User.add(..))")
       public void point(){}
       @Before(value = "point()")
       public void beforeNotice() {
           System.out.println("å‰ç½®é€šçŸ¥");
       }*/
          
       //    é…ç½®å‰ç½®é€šçŸ¥
       @Before(value = "execution(* com.loy.aop.ant.User.add(..))")
       public void beforeNotice() {
           System.out.println("å‰ç½®é€šçŸ¥");
       }
   
       //    é…ç½®åç½®é€šçŸ¥
       @AfterReturning(value = "execution(* com.loy.aop.ant.User.add(..))")
       public void finallyNotice() {
           System.out.println("åç½®é€šçŸ¥");
       }
   
       //å¼‚å¸¸é€šçŸ¥
       @AfterThrowing(value = "execution(* com.loy.aop.ant.User.add(..))")
       public void throwNotice() {
           System.out.println("å¼‚å¸¸é€šçŸ¥");
       }
   
       //    ç¯ç»•é€šçŸ¥
       @Around(value = "execution(* com.loy.aop.ant.User.add(..))")
       public void aroundNotice(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
           System.out.println("ç¯ç»•é€šçŸ¥å‰");
   //è°ƒç”¨åˆ‡å…¥ç‚¹
           proceedingJoinPoint.proceed();
           System.out.println("ç¯ç»•é€šçŸ¥å");
       }
   
       //æœ€ç»ˆé€šçŸ¥
       @After(value = "execution(* com.loy.aop.ant.User.add(..))")
       public void afterNotice() {
           System.out.println("æœ€ç»ˆé€šçŸ¥");
       }
   }
   ```

   æ³¨ï¼š

   æŠ½å–å…¬å…±åˆ‡å…¥ç‚¹ï¼š`@Pointcut(value="execution(* com.loy.aop.ant.User.add(..))")`

   å½“æœ‰å¤šä¸ªå¢å¼ºç±»å¯¹åŒä¸€ä¸ªæ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œä½¿ç”¨ `@Order(æ•°å€¼)`è®¾ç½®ä¼˜å…ˆçº§ï¼›æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜