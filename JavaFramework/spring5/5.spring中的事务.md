##  Spingäº‹åŠ¡

> ACIDï¼š
>
> æ³¨ï¼šæ¶‰åŠäº‹åŠ¡ï¼Œæ•°æ®åº“å¼•æ“å¿…é¡»æ˜¯InnoDB

å¼•å…¥ä¾èµ–ï¼š

`spring-tx-5.2.5.RELEASE.jar`//äº‹åŠ¡çš„ä¾èµ–



###  äº‹åŠ¡æ“ä½œ

> äº‹åŠ¡ä¸€èˆ¬æ·»åŠ åˆ°serviceå±‚
>

######  äº‹åŠ¡ç®¡ç†ä¸­çš„API

é’ˆå¯¹ä¸åŒæ¡†æ¶æä¾›ä¸åŒçš„å®ç°ç±»

![image-20230719105348182](./Typora_img/5.springä¸­çš„äº‹åŠ¡.assets/image-20230719105348182.png)

###### ä¸¤ç§äº‹åŠ¡ç®¡ç†ï¼š

1. ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†

   ç¼ºç‚¹ï¼šåœ¨éœ€è¦äº‹åŠ¡æ—¶ï¼Œéƒ½è¦å†™ä¸€éä¸‹è¿°ä»£ç ï¼Œå†—ä½™åº¦é«˜

   ```java
   public void transfer(){
           try {
   //        1.å¼€å¯äº‹åŠ¡
   
   //        2.ä¸šåŠ¡æ“ä½œ
               //å¼ ä¸‰ï¼ˆid=1ï¼‰å‘æå››ï¼ˆid=2ï¼‰å¾®ä¿¡è½¬è´¦ä¸‰ç™¾å—
               accountDaoImpl.outcome(1, 300);
   //            æ¨¡æ‹Ÿå¼‚å¸¸
   //            int i=10/0;
               accountDaoImpl.income(2, 300);
   //        3.è‹¥æ²¡æœ‰å¼‚å¸¸ï¼Œæäº¤äº‹åŠ¡
           }catch (Exception e) {
   //        4.è‹¥æœ‰å¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡
           }
       }
   ```

2. **å£°æ˜å¼äº‹åŠ¡ç®¡ç†**ï¼ˆğŸ“Œæ¨èä½¿ç”¨ï¼Œåº•å±‚ä¸ºAOPåŸç†ï¼‰

   - **ä½¿ç”¨æ³¨è§£æ–¹å¼å®ç°**ï¼šï¼ˆä¸»è¦å­¦ä¹ æ³¨è§£å¼ï¼‰

     æé«˜ä»£ç å¯å¤ç”¨æ€§ï¼Œç®€åŒ–å¼€å‘

     ```java
         @Transactional(äº‹åŠ¡å‚æ•°)
         public void transferByTx(){
             //å¼ ä¸‰ï¼ˆid=1ï¼‰å‘æå››ï¼ˆid=2ï¼‰å¾®ä¿¡è½¬è´¦ä¸‰ç™¾å—
             accountDaoImpl.outcome(1, 300);
     //            æ¨¡æ‹Ÿå¼‚å¸¸
     //            int i=10/0;
             accountDaoImpl.income(2, 300);
         }
     ```

     å‡†å¤‡æ­¥éª¤ï¼š

     1. é…ç½®ç±»æ–¹å¼ï¼ˆå®Œå…¨æ³¨è§£ï¼Œé…ç½®ç±»ï¼‰(æ¨èä½¿ç”¨)

        ```java
        @Configuration
        @ComponentScan(basePackages = "com.loy.tx")
        @EnableTransactionManagement//å¼€å¯äº‹åŠ¡
        public class SpringConfig {
        //    æ•°æ®åº“è¿æ¥æ± 
            @Bean
            public DruidDataSource getDruidDataSource(){
                DruidDataSource druidDataSource = new DruidDataSource();
                druidDataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
                druidDataSource.setUrl("jdbc:mysql://localhost:3306/tr_account?&rewriteBatchedStatements=true&serverTimezone=GMT%2B8&useSSL=false");
                druidDataSource.setUsername("root");
                druidDataSource.setPassword("");
                return druidDataSource;
            }
        
        //    åˆ›å»ºjdbcTemplateå¯¹è±¡
            @Bean
            public JdbcTemplate getJdbcTemplate(DataSource dataSource){
                JdbcTemplate jdbcTemplate = new JdbcTemplate();
        //        æ³¨å…¥dataSource
                jdbcTemplate.setDataSource(dataSource);
                return jdbcTemplate;
            }
        
        //    åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨
            @Bean
            public DataSourceTransactionManager getDataSourceTransactionManager(DataSource dataSource){
                DataSourceTransactionManager dataSourceTransactionManager = new DataSourceTransactionManager();
                dataSourceTransactionManager.setDataSource(dataSource);
                return dataSourceTransactionManager;
            }
        }
        
        ```

        

     2. é…ç½®xml

        - xmlä¸­é…ç½®äº‹åŠ¡ç®¡ç†å™¨

          ```xml
          <!--    åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨-->
              <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
          <!--        æ³¨å…¥æ•°æ®æº-->
                  <property name="dataSource" ref="dataSource"></property>
              </bean>
          ```

        - å¼•å…¥åç§°ç©ºé—´tx

          ```xml
           xmlns:tx="http://www.springframework.org/schema/tx"
           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
          ```

        - å¼€å¯äº‹åŠ¡æ³¨è§£

          ```xml
          <!--    å¼€å¯äº‹åŠ¡æ³¨è§£-->
              <tx:annotation-driven transaction-manager="transactionManager"></tx:annotation-driven>
          ```

        - åœ¨serviceç±»ä¸Šæ·»åŠ äº‹åŠ¡æ³¨è§£

          æ·»åŠ ç±»ä¸Šï¼šè¯¥ç±»æ‰€æœ‰æ–¹æ³•æ·»åŠ äº‹åŠ¡

          æ·»åŠ æ–¹æ³•ä¸Šï¼šè¯¥æ–¹æ³•æŒæœ‰äº‹åŠ¡

     

   - ä½¿ç”¨xmlé…ç½®å®ç°ï¼š

     ```xml
     <!--    ä½¿ç”¨xmlæ–¹å¼é…ç½®äº‹åŠ¡-->
     <!--    é…ç½®é€šçŸ¥-->
         <tx:advice id="txAdvice">
     <!--        é…ç½®äº‹åŠ¡å‚æ•°-->
             <tx:attributes>
                 <tx:method name="transfer" propagation="REQUIRED"/>
             </tx:attributes>
         </tx:advice>
         <aop:config>
     <!--        é…ç½®åˆ‡å…¥ç‚¹-->
             <aop:pointcut id="pt" expression="execution(* com.loy.tx.service.AccountService.transfer(..))"/>
     <!--        é…ç½®åˆ‡é¢-->
             <aop:advisor advice-ref="txAdvice" pointcut-ref="pt"></aop:advisor>
          </aop:config>
     ```

######  äº‹åŠ¡å‚æ•°

- Propagationï¼šäº‹åŠ¡ä¼ æ’­è¡Œä¸º

  - REQUIREDï¼šå¦‚æœæœ‰äº‹åŠ¡è¿è¡Œï¼Œå½“å‰çš„æ–¹æ³•å°±åœ¨è¯¥äº‹åŠ¡å†…è¿è¡Œï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯åŠ¨æ–°äº‹åŠ¡å¹¶åœ¨å…¶ä¸­è¿è¡Œ

  - REQUIRED_NEWï¼šå½“å‰æ–¹æ³•å¿…é¡»å¯åŠ¨æ–°äº‹åŠ¡ï¼Œå¹¶åœ¨è‡ªå·±çš„äº‹åŠ¡å†…è¿è¡Œï¼Œå¦‚æœæœ‰äº‹åŠ¡è¿è¡Œå¿…é¡»å°†å…¶æŒ‚èµ·

  - SUPPORTSï¼šå¦‚æœæœ‰äº‹åŠ¡åœ¨è¿è¡Œï¼Œå½“å‰æ–¹æ³•å°±åœ¨æ­¤äº‹åŠ¡å†…è¿è¡Œï¼›å¦‚æœæ²¡æœ‰äº‹åŠ¡è¿è¡Œï¼Œåˆ™å½“å‰æ–¹æ³•å¯ä¸è¿è¡Œåœ¨äº‹åŠ¡ä¸­

- Isolationï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«

  ![image-20230719151354762](./Typora_img/5.springä¸­çš„äº‹åŠ¡.assets/image-20230719151354762.png)

- timeoutï¼šè¶…æ—¶æ—¶é—´

  äº‹åŠ¡éœ€è¦åœ¨ä¸€å®šæ—¶é—´è¿›è¡Œæäº¤ï¼Œè‹¥ä¸æäº¤åˆ™å›æ»šï¼›é»˜è®¤å€¼-1ï¼Œè®¾ç½®æ—¶é—´ä»¥ç§’ä¸ºå•ä½

- readOnlyï¼šæ˜¯å¦åªè¯»

  ï¼ˆtrueï¼‰è¯»ï¼šæŸ¥è¯¢æ“ä½œï¼›ï¼ˆé»˜è®¤å€¼falseï¼‰å†™ï¼šæ·»åŠ /ä¿®æ”¹/åˆ é™¤æ“ä½œ

- rollbackForï¼šå›æ»š

  è®¾ç½®å‡ºç°å“ªäº›å¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»š

- noRollbackForï¼šä¸å›æ»š

  è®¾ç½®å‡ºç°å“ªäº›å¼‚å¸¸ä¸è¿›è¡Œäº‹åŠ¡å›æ»š