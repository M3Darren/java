##  WebFlux

ä»‹ç»ï¼š

â€‹		Spring5æ–°å¢æ¨¡å—ï¼Œç”¨äºwebå¼€å‘ï¼ŒåŠŸèƒ½ç±»ä¼¼SpringMVCï¼Œä½¿ç”¨å‡½æ•°å¼ï¼ˆLambdaï¼‰ç¼–ç¨‹

###  å¼‚æ­¥éé˜»å¡ç‰¹æ€§

**å¼‚æ­¥éé˜»å¡**çš„æ¡†æ¶ï¼Œæ ¸å¿ƒåŸºäºReactorç›¸å…³APIå®ç°

- è°ƒç”¨è€…ï¼šï¼ˆå‘é€è¯·æ±‚ï¼‰

  åŒæ­¥ï¼ˆå‘é€è¯·æ±‚*ç­‰å¾…å“åº”*ç„¶åç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ï¼‰ã€å¼‚æ­¥ï¼ˆå‘é€è¯·æ±‚*ä¸ç­‰å¾…å“åº”*ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ï¼‰

- è¢«è°ƒç”¨è€…ï¼ˆæ¥æ”¶è¯·æ±‚ï¼‰

  é˜»å¡ï¼ˆæ¥æ”¶è¯·æ±‚åï¼Œ*å®Œæˆæ“ä½œå†ç»™å‡ºåé¦ˆ*ï¼‰ã€éé˜»å¡ï¼ˆæ”¶åˆ°è¯·æ±‚åï¼Œ*ç«‹å³ç»™å‡ºåé¦ˆå†å®Œæˆæ“ä½œ*ï¼‰

###  WebFluxä¸SpringMVCæ¯”è¾ƒ

ä½¿ç”¨åœºæ™¯ï¼šWebFluxé€‚ç”¨é«˜å¹¶å‘ï¼ŒSpringMVCé€‚åˆä¼ ç»Ÿwebå¼€å‘

- ä¸¤ä¸ªæ¡†æ¶éƒ½å¯ä½¿ç”¨æ³¨è§£ï¼Œéƒ½è¿è¡Œåœ¨å®¹å™¨ä¸­
- SpringMVCé‡‡ç”¨å‘½ä»¤å¼ç¼–ç¨‹ï¼›WebFluxé‡‡ç”¨å¼‚æ­¥å“åº”å¼ç¼–ç¨‹
- **SpringMVCæ˜¯åŒæ­¥é˜»å¡æ–¹å¼ï¼ŒåŸºäºSpringMVC+Servlet+Tomcatå®ç°**
- **SpringWebFluxæ˜¯å¼‚æ­¥éé˜»å¡æ–¹å¼ï¼ŒåŸºäºSpringWebFlux+Reactor+Nettyå®ç°**

<img src="./Typora_img/7.springæ–°åŠŸèƒ½-WebFlux.assets/spring-mvc-and-webflux-venn.png" alt="spring mvc and webflux venn" style="zoom: 67%;margin-left:10px" />

---

###  å“åº”å¼ç¼–ç¨‹

> å“åº”å¼ç¼–ç¨‹æ˜¯ä¸€ç§é¢å‘æ•°æ®æµå’Œå˜åŒ–ä¼ æ’­çš„ç¼–ç¨‹èŒƒå¼ï¼›å½“æ•°æ®å‘ç”Ÿæ”¹å˜ï¼Œå¯¹åº”è¢«è°ƒç”¨æ•°æ®çš„ç»“æœå“åº”å‘ç”Ÿæ”¹å˜

####  å†ç¨‹ï¼š

- java8åŠä»¥å‰ï¼Œä½¿ç”¨Observerå’ŒObservableä¸¤ä¸ªè§‚å¯Ÿè€…æ¨¡å¼ç±»å®ç°ä¼ªå“åº”å¼ï¼›
- java9åŠåç»­ç‰ˆæœ¬ä½¿ç”¨Flowç±»å®ç°çœŸæ­£çš„å“åº”å¼

 ####  Reactoræ¡†æ¶å®ç°ğŸ“Œ

> åŸºäºjava9ä¸­çš„Flowå°è£…å®ç°

- ä¸¤ä¸ªæ ¸å¿ƒç±»ï¼šMonoå’ŒFluxï¼Œå®ç°äº†Publisheræ¥å£

  Fluxå¯¹è±¡å®ç°å‘å¸ƒè€…ï¼Œè¿”å›Nä¸ªå…ƒç´ 

  Monoå¯¹è±¡å®ç°å‘å¸ƒè€…ï¼Œè¿”å›0æˆ–1ä¸ªå…ƒç´ 

  ```java
  public static void main(String[] args) {
  //        ä½¿ç”¨justæ–¹æ³•ç›´æ¥å£°æ˜
          Flux<Integer> just = Flux.just(111, 222, 333);
          Mono<Integer> just1 = Mono.just(111);
          
  //        ä½¿ç”¨å…¶ä»–æ–¹å¼
  //        1.fromArrayï¼šæ•°ç»„
          Integer[] intArr={1,2,3};
          Flux<Integer> integerFlux = Flux.fromArray(intArr);
  //        2.fromIterableï¼šé›†åˆ
          List<Integer> list= Arrays.asList(intArr);
          Flux<Integer> integerFlux1 = Flux.fromIterable(list);
  //        3.fromStreamï¼šæµ
          Stream<Integer> stream=list.stream();
          Flux<Integer> integerFlux2 = Flux.fromStream(stream);
      }
  ```

- Fluxå’ŒMonoéƒ½æ˜¯æ•°æ®æµçš„å‘å¸ƒè€…ï¼Œå¯å‘å‡ºä¸‰ç§æ•°æ®ä¿¡å·ï¼ˆå…ƒç´ å€¼ã€ã€é”™è¯¯ä¿¡å·ã€å®Œæˆä¿¡å·ã€‘ï¼ˆä¹Ÿç§°ç»ˆæ­¢ä¿¡å·ï¼‰ï¼‰ï¼›ç»ˆæ­¢ä¿¡å·ç”¨äºå‘Šè¯‰è®¢é˜…è€…æ•°æ®æµç»“æŸã€‚å¹¶ä¸”é”™è¯¯ä¿¡å·å’Œå®Œæˆä¿¡å·åªèƒ½å­˜åœ¨ä¸€ä¸ª

- ä½¿ç”¨justæˆ–è€…å…¶ä»–æ–¹æ³•åªæ˜¯å£°æ˜æµï¼Œåªæœ‰è®¢é˜…ï¼ˆsubscribe()ï¼‰åæ‰ä¼šè§¦å‘æ•°æ®æµï¼›

  ```java
          Flux<Integer> just = Flux.just(111, 222, 333);
          just.subscribe(System.out::println);
  ```

- æä¾›ä¸°å¯Œçš„æ“ä½œç¬¦

  1. mapï¼šå°†å…ƒç´ æ˜ å°„ä¸ºæ–°çš„å…ƒç´ 
  
     <img src="./Typora_img/7.springæ–°åŠŸèƒ½-WebFlux.assets/image-20230721144946628.png" alt="image-20230721144946628" style="zoom: 50%;margin-left:10px" />
  
  2. flatMapï¼šå°†æ¯ä¸ªå…ƒç´ è½¬æ¢ä¸ºæµï¼Œè½¬æ¢ä¹‹åå°†å¤šä¸ªæµåˆå¹¶ä¸ºä¸€ä¸ªæµ
  
     <img src="./Typora_img/7.springæ–°åŠŸèƒ½-WebFlux.assets/image-20230721145052318.png" alt="image-20230721145052318" style="zoom:50%;margin-left:10px" />

####  WebFluxæ‰§è¡Œæµç¨‹ä¸æ ¸å¿ƒAPI

> WebFluxåŸºäºReactorå®ç°ï¼Œä½¿ç”¨å®¹å™¨ä¸ºNetty

#####  Nettyï¼ˆé«˜æ€§èƒ½çš„NIOå¼‚æ­¥éé˜»å¡æ¡†æ¶ï¼‰

- BIOï¼ˆé˜»å¡ï¼‰

  <img src="./Typora_img/7.springæ–°åŠŸèƒ½-WebFlux.assets/image-20230721152216542.png" alt="image-20230721152216542" style="zoom:80%;" />

- NIOï¼ˆéé˜»å¡ï¼‰ï¼ˆNettyé»˜è®¤ä½¿ç”¨ï¼‰

  <img src="./Typora_img/7.springæ–°åŠŸèƒ½-WebFlux.assets/image-20230721152243738.png" alt="image-20230721152243738" style="zoom:70%;margin-left:10px" />

#####  æ ¸å¿ƒæ§åˆ¶å™¨DispatchHandler

ç”¨äºå¤„ç†è¯·æ±‚

- HandleMappingï¼šè¯·æ±‚æŸ¥è¯¢åˆ°å¤„ç†çš„æ–¹æ³•
- HandlerAdapterï¼šè´Ÿè´£è¯·æ±‚å¤„ç†
- HandleResultHandlerï¼šå“åº”ç»“æœå¤„ç†

#####  å®ç°æ¥å£WebHandler

#####  å®ç°å‡½æ•°å¼ç¼–ç¨‹

å®ç°äº†RouterFunctionå’ŒHandlerFunctionæ¥å£

---

###  æ³¨è§£ç¼–ç¨‹æ¨¡å‹ï¼ˆé‡ç‚¹ğŸ“Œï¼‰

```java
@RestController
public class UserController {
    //æ³¨å…¥service
    @Autowired
    private UserService userService;
    //idæŸ¥è¯¢
    @GetMapping("/user/{id}")
    public Mono<User> getUser(@PathVariable int id){
        return userService.getUserById(id);
    }

//    æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
    @GetMapping("/allUser")
    public Flux<User> getAll(){
        return userService.getAllUser();
    }
    @PostMapping("/saveUser")
    public Mono<Void> save(@RequestBody User user){
        Mono<User> just = Mono.just(user);
        return userService.saveUser(just);
    }
}
```





###  å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ï¼ˆäº†è§£ï¼‰

- springWebfluxè¯·æ±‚å’Œå“åº”ä¸å†æ˜¯ServletRequsetå’ŒServletResponseï¼›è€Œæ˜¯SeverRequestå’ŒServerResponse
- RouterFunctionï¼šå®ç°è·¯ç”±åŠŸèƒ½ï¼Œè¯·æ±‚è½¬å‘ç»™å¯¹åº”handler
- HandlerFunctionï¼šå¤„ç†è¯·æ±‚ç”Ÿæˆå“åº”

å®ç°æ­¥éª¤ï¼š

1. åˆ›å»ºspring booté¡¹ç›®ï¼›åˆ›å»ºhandlerç¼–å†™é€»è¾‘
2. é…ç½®æœåŠ¡å™¨ï¼Œç¼–å†™è·¯ç”±ï¼›å®Œæˆé€‚é…

